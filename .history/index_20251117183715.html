<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>防汛通報系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      padding: 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .year-block, .month-block, .day-block {
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      background: white;
      margin-bottom: 4px;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      background: #e8eef8;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-icon svg {
  width: 26px;
  height: 26px;
  color: #333;
}

/* 展開後 header 的下方要留距離 */
.header + .content {
  margin-top: 8px;
}

    .content {
      display: none;
      padding: 0 16px 12px;
    }

    .record {
  display: flex;
  align-items: center;
  font-size: 18px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
  gap: 6px;
  cursor: pointer;
}

    .record:last-child {
      border-bottom: none;
    }

    /* 讓所有區塊之間保持距離 */
.year-block, .month-block, .day-block {
  margin-bottom: 14px;
}

/* 讓展開的內容不會緊貼 header */
.content {
  margin-top: 8px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: #E53935;
}

/* === 修正展開後的區塊間距 === */
/* 展開後的外框保留較大空隙 */
.block-open {
  margin-bottom: 12px !important;
}

/* 讓展開後的 content 有內距，避免黏住 */
.year-block > .content,
.month-block > .content,
.day-block > .content {
  padding-top: 12px;
}

/* 日期展開後的紀錄字體加大 */
.day-block .record {
  font-size: 20px;   /* 你可改成 20 / 24 */
}

/* 本月無巡視紀錄 字體與一般紀錄一致 */
.month-block .record {
  font-size: 20px;
}

#loadingMask {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-size: 28px;
  color: white;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #eee;
  border-top: 4px solid #0b5ed7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 14px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.loadingText {
  display: none;
}
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>


    <div id="debug" style="white-space: pre-line; font-size:14px; color:#c00; margin-bottom:16px;"></div>


<div id="loadingMask">
  <div class="spinner"></div>

  <div id="text-loading" class="loadingText">載入中…</div>
  <div id="text-update" class="loadingText">資料更新中，請耐心等候…</div>
  <div id="text-init" class="loadingText">資料初始化中，請耐心等候…</div>

  <!-- 錯誤訊息預留（可選） -->
  <div id="text-error" class="loadingText">無法連線到資料來源</div>
  <div id="text-error-format" class="loadingText">資料格式錯誤，請聯絡管理員</div>
  <div id="text-error-notfound" class="loadingText">找不到您的志工資料</div>
</div>

<h2 id="pageTitle" style="display:none;">回報紀錄</h2>

<div id="switchArea" style="
  display:none;
  text-align:center;
  margin-top:10px;
  margin-bottom:18px;
">
  <button id="btnSelf" style="
    padding:6px 16px;
    font-size:18px;
    border:2px solid #0b5ed7;
    background:#0b5ed7;
    color:white;
    border-radius:6px;
    margin-right:6px;
  ">我的紀錄</button>

  <button id="btnTeam" style="
    padding:6px 16px;
    font-size:18px;
    border:2px solid #0b5ed7;
    background:white;
    color:#0b5ed7;
    border-radius:6px;
  ">大隊紀錄</button>
</div>

<!-- 清單真正呈現的地方，一開始先隱藏 -->
<div id="listContainer" style="display: none;"></div>

<script>

  const VOLUNTEER_API_URL = "https://script.google.com/macros/s/AKfycbxiGSG5hSMO6We-C6cyEJZLgf4Rnbjp-6w9Tmb0qfF9VM6JB4YGEMqj3QRfTzg7Czpc/exec"; 
const REPORT_GAS_URL = "https://script.google.com/macros/s/AKfycbwnMoUKj2OXKBjfmIofN4HoVexxMNVXvmo9VxPbqhgLSkx2sfNbaDspXZefn9cAIdkZRg/exec";

let globalNickname = "";
let globalRole = "";
let globalTeam = "";
let globalName = "";  // ★ 必須補這行
let viewMode = "self";  // self = 看自己, team = 看大隊

function debug(msg) {
  try {
    const box = document.getElementById("debug");
    if (box) box.textContent += msg + "\n";
  } catch (e) {}
}

  /* ------------------------------------------
      1. 初始化：登入 LIFF 並取得資料
  -------------------------------------------*/
  async function main() {

    await liff.init({ liffId: "2007934728-jZkMLlPO" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    globalNickname = profile.displayName;

    // step2 → 向 GAS 要 user 資料（權限/大隊等）
    loadUserInfo(globalNickname);
  }


  /* ------------------------------------------
      2. 讀取使用者權限 + 大隊等資訊
  -------------------------------------------*/
  async function loadUserInfo(nickname) {

  debug("STEP1: 開始取得志工資料，nickname=" + nickname);

    // ★★★ 檢查舊快取（沒 role → 自動作廢）
  const oldCache = localStorage.getItem("userInfoCache");
  if (oldCache) {
    const parsedOld = JSON.parse(oldCache);
    if (!parsedOld.role) {
      debug("偵測到舊快取（缺少 role），已自動刪除");
      localStorage.removeItem("userInfoCache");
    }
  }

  const mask = document.getElementById("loadingMask");
  const tLoad = document.getElementById("text-loading");
  const tUpdate = document.getElementById("text-update");
  const tInit = document.getElementById("text-init");

  // 先全部隱藏
  tLoad.style.display = "none";
  tUpdate.style.display = "none";
  tInit.style.display = "none";

  // ★ 一進頁就立即顯示遮罩（無延遲）
  mask.style.display = "flex";

  const cache = localStorage.getItem("userInfoCache");
  const now = Date.now();
  const expires = 10 * 1000; // 測試：5 秒過期
  //const expires = 180 * 24 * 60 * 60 * 1000; // 正式用 180 天

  /* ============================================================
      A. 有快取 & 未過期 → 顯示「載入中」
         （不用抓權限資料）
  ============================================================ */
  if (cache) {
    const parsed = JSON.parse(cache);

    debug("當前快取：" + cache);

    if (now - parsed.timestamp < expires) {

      tLoad.style.display = "block";  // ★ 唯一顯示的文字

      globalRole = parsed.role;
      globalTeam = parsed.team;
      globalName = parsed.name;

      // ★ 大隊長 或 管理員 才能切換
if (globalRole === "大隊長" || globalRole === "管理員") {
  document.getElementById("switchArea").style.display = "block";
}

      loadRecordList();   // 直接載入紀錄
      return;
    }

    /* ============================================================
        B. 有快取但過期 → 一律顯示「資料更新中」
           （顯示到底：不會跳去載入中）
    ============================================================ */
    tUpdate.style.display = "block";  // ★ 唯一顯示的文字

  } else {

    /* ============================================================
        C. 第一次毫無快取 → 一律顯示「資料初始化中」
           （顯示到底：不會跳去載入中）
    ============================================================ */
    tInit.style.display = "block";  // ★ 唯一顯示的文字
  }

  /* ============================================================
      D. 呼叫 API （只有 B & C 會呼叫）
  ============================================================ */
  const url = `${VOLUNTEER_API_URL}?action=query&nickname=${nickname}`;
  debug("STEP1-API 呼叫：" + url);

  let res, text;

  try {
    res = await fetch(url);
    text = await res.text();
  } catch (err) {
    document.getElementById("text-error").style.display = "block";
    return;
  }

  if (text.startsWith("callback")) {
    text = text.replace(/^callback\(/, "").replace(/\);$/, "");
  }

  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    document.getElementById("text-error-format").style.display = "block";
    return;
  }

  if (!json.success) {
    document.getElementById("text-error-notfound").style.display = "block";
    return;
  }

  /* ============================================================
      E. 更新快取 → 載入紀錄（仍保持 B or C 的文字）
  ============================================================ */
  globalName = json.data.姓名;
  globalTeam = json.data.大隊;
  globalRole = json.data.權限 || "志工";

  debug("儲存的權限：" + globalRole);

  localStorage.setItem("userInfoCache", JSON.stringify({
    name: globalName,
    team: globalTeam,
    role: globalRole,
    timestamp: Date.now()
  }));

  if (globalRole === "大隊長" || globalRole === "管理員") {
    document.getElementById("switchArea").style.display = "block";
}

  // 直接載入紀錄
  loadRecordList();
}

  /* ------------------------------------------
      3. 從 GAS 取得回報記錄（未來串 API）
  -------------------------------------------*/
  async function loadRecordList() {

  const url = `${REPORT_GAS_URL}?action=listReports`;
  debug("STEP2: 開始取得巡視紀錄：" + url);

  let res, text;

  try {
    res = await fetch(url);
    text = await res.text();
  } catch (err) {
    debug("STEP2-連線失敗：" + err);
    document.getElementById("loading").innerHTML = "巡視紀錄載入失敗（連線錯誤）";
    return;
  }

  debug("STEP2-API 回傳原始資料：" + text);

  // JSONP → 去掉 callback(...);
  if (text.startsWith("callback")) {
    text = text.replace(/^callback\(/, "").replace(/\);$/, "");
    debug("STEP2-去除 JSONP 後：" + text);
  }

  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    debug("STEP2-JSON 解析失敗：" + err + "\n原始：" + text);
    document.getElementById("loading").innerHTML = "巡視紀錄格式錯誤，請聯絡管理員";
    return;
  }

  debug("STEP2-解析後 JSON：" + JSON.stringify(json));

  if (!json.success) {
    document.getElementById("listContainer").innerHTML = "無法取得巡視紀錄";
    debug("STEP2-巡視紀錄載入失敗：" + JSON.stringify(json));
    return;
  }

  const list = json.records || [];
  debug("STEP2-成功取得紀錄數量：" + list.length);

  renderList(list);
}


  /* ------------------------------------------
      4. 渲染「年度 → 月份 → 日期 → 紀錄」
  -------------------------------------------*/
  function normalizeDate(dateStr) {
  // 若是 ISO 格式：2025-11-11T16:00:00.000Z
  if (dateStr.includes("T")) {
    const d = new Date(dateStr);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd}`;
  }
  return dateStr; // 若本來就是 yyyy/mm/dd
}

function renderList(records) {

    let finalRecords = records;

// 我的紀錄 → 只要回報者 = 自己的姓名
if (viewMode === "self") {
  finalRecords = records.filter(r => {
    return (r.回報者 || "").trim() === globalName;
  });
}

// 大隊紀錄 → 全部
// viewMode === "team" 就保持原本 finalRecords = records

    globalRecords = records;  // ★ 讓切換模式能重新渲染

  debug("STEP3: 進入 renderList，顯示筆數=" + finalRecords.length);

  const container = document.getElementById("listContainer");
  container.innerHTML = "";

  // 取得現在的年份與月份（民國）
  const now = new Date();
  const currentYear = now.getFullYear() - 1911;
  const currentMonth = now.getMonth() + 1;

  // --- step 1：把 records 按 月 / 日 分組 ---
  const grouped = {};  // grouped[month][day] = [records]
  for (let m = 1; m <= 12; m++) grouped[m] = {};

  finalRecords.forEach(r => {

    // ★ 修正日期格式
    const normalized = normalizeDate(r.日期);
    debug("STEP3-日期修正：" + r.日期 + " → " + normalized);

    const dateParts = normalized.split("/");
    const m = parseInt(dateParts[1], 10);
    const d = parseInt(dateParts[2], 10);

    if (!grouped[m][d]) grouped[m][d] = [];
    grouped[m][d].push(r);
  });

  debug("STEP3-1: 日期分組完成");

  // --- step 2：建立年份區塊 ---
  const yearBlock = createBlock(`${currentYear} 年`, "year");
  const yearContent = yearBlock.querySelector(".content");

  // --- step 3：從資料自動取得「有紀錄的月份」(不顯示未來月份) ---
const months = Object.keys(grouped)
  .map(m => parseInt(m, 10))
  .filter(m => Object.keys(grouped[m]).length > 0) // 有資料的月份
  .filter(m => m <= currentMonth)                  // 不能超過現在月份
  .sort((a, b) => b - a);                          // 由新到舊排序

debug("STEP3-2 顯示月份排列 = " + months.join(", "));

  // --- step 4：逐月渲染 ---
  months.forEach(month => {

  const monthBlock = createBlock(`${month} 月`, "month");
  const monthContent = monthBlock.querySelector(".content");

  const days = Object.keys(grouped[month]).sort((a, b) => b - a);

  if (days.length === 0) {
    const emptyDiv = document.createElement("div");
    emptyDiv.className = "record";
    emptyDiv.textContent = "本月無巡視紀錄";
    monthContent.appendChild(emptyDiv);

  } else {

    // --- 列出日期 ---
    days.forEach(day => {

      const dayBlock = createBlock(`${day} 日`, "day");
      const dayContent = dayBlock.querySelector(".content");

      grouped[month][day].forEach(record => {

  const div = document.createElement("div");
  div.className = "record";

  // ★ 正確抓時間：從 URL 裡面取 timestamp
let hh = "--", mm = "--";
let ampm = "";   // ★★★ 必須加在 try 外，避免 ampm undefined 導致 JS 卡住

try {
  const match = record.詳細紀錄.match(/report_(\d+)/);
  if (match) {
    const t = parseInt(match[1], 10);
    const dateObj = new Date(t);

    const hours = dateObj.getHours();
hh = String(hours).padStart(2, "0");
mm = String(dateObj.getMinutes()).padStart(2, "0");
ampm = ""; // 24 小時制就不需要 上午/下午
  }
} catch (e) {
  console.warn("無法解析時間：", record.詳細紀錄);
}

// 是否異常
const status = (record.狀態 || "").trim();
const isAbnormal = status === "異常";

// === 時間 + 狀態 ===
const timeText = document.createElement("span");
timeText.textContent = `${hh}:${mm}｜${status}`;
div.appendChild(timeText);

// ★ 只有大隊紀錄模式才顯示回報者姓名
if (viewMode === "team") {
  const nameSpan = document.createElement("span");
  nameSpan.textContent = `｜${record.回報者}`;
  div.appendChild(nameSpan);
}

// === 紅點（只有異常時） ===
if (isAbnormal) {
  const dot = document.createElement("span");
  dot.className = "status-dot";
  div.appendChild(dot);   // 緊貼異常後
}

  // 點擊事件
  div.onclick = () => {
    window.location.href = record.詳細紀錄;
  };

  dayContent.appendChild(div);
});

      monthContent.appendChild(dayBlock);
    });
  }

  yearContent.appendChild(monthBlock);
});

  container.appendChild(yearBlock);

  // 渲染完成後顯示真正內容
document.getElementById("loadingMask").style.display = "none";
document.getElementById("pageTitle").style.display = "block";
document.getElementById("listContainer").style.display = "block";   // ★ 必須補這行

  debug("STEP3 完成：列表渲染成功");
}

  /* ------------------------------------------
      5. 工具：建立可收合區塊
  -------------------------------------------*/
  function createBlock(title, level) {
  const block = document.createElement("div");
  block.className = level + "-block";

  const header = document.createElement("div");
  header.className = "header";

  const titleSpan = document.createElement("span");
  titleSpan.textContent = title;

  // ▼（預設收起用）
  const icon = document.createElement("span");
  icon.className = "toggle-icon";
  icon.innerHTML = `
  <svg width="40" height="40" viewBox="0 0 24 24">
    <path fill="#666" d="M5 8l7 8 7-8z"/>
  </svg>
`;

  const content = document.createElement("div");
  content.className = "content";
  content.style.display = "none";

  header.appendChild(titleSpan);
  header.appendChild(icon);

  header.onclick = () => {
  const willOpen = content.style.display !== "block";

  content.style.display = willOpen ? "block" : "none";

  icon.innerHTML = willOpen
    ? `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 16l7-8 7 8z"/>  <!-- 向上 -->
       </svg>`
    : `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 8l7 8 7-8z"/>  <!-- 向下 -->
       </svg>`;
};

  block.appendChild(header);
  block.appendChild(content);

  return block;
}

document.getElementById("btnSelf").onclick = function () {
  viewMode = "self";
  renderList(globalRecords);
  updateSwitchUI();
};

document.getElementById("btnTeam").onclick = function () {
  viewMode = "team";
  renderList(globalRecords);
  updateSwitchUI();
};

// 按鈕視覺切換
function updateSwitchUI() {
  const btnSelf = document.getElementById("btnSelf");
  const btnTeam = document.getElementById("btnTeam");

  if (viewMode === "self") {
    btnSelf.style.background = "#0b5ed7";
    btnSelf.style.color = "white";
    btnTeam.style.background = "white";
    btnTeam.style.color = "#0b5ed7";
  } else {
    btnTeam.style.background = "#0b5ed7";
    btnTeam.style.color = "white";
    btnSelf.style.background = "white";
    btnSelf.style.color = "#0b5ed7";
  }
}

  main();
</script>

</body>
</html>