<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>巡視紀錄列表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      padding: 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .year-block, .month-block, .day-block {
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      background: white;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      background: #e8eef8;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .content {
      display: none;
      padding: 0 16px 12px;
    }

    .record {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: 18px;
    }

    .record:last-child {
      border-bottom: none;
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>

<h2>巡視紀錄列表</h2>

<!-- 初始化時顯示（抓權限、抓紀錄、準備資料） -->
<div id="loading" style="
  font-size: 18px;
  text-align: center;
  padding: 20px;
  color: #555;
">
  資料初始化中，請稍候…
</div>

<!-- 清單真正呈現的地方，一開始先隱藏 -->
<div id="listContainer" style="display: none;"></div>

<script>

  const VOLUNTEER_API_URL = "https://script.google.com/macros/s/AKfycbxiGSG5hSMO6We-C6cyEJZLgf4Rnbjp-6w9Tmb0qfF9VM6JB4YGEMqj3QRfTzg7Czpc/exec"; 
const REPORT_GAS_URL    = "https://script.google.com/macros/s/AKfycbyoNSMy8VInpBuEYsF4J_QQ2uwsV43b1caD6TYIcK_ABrw7y4rewdJq3bSOYSwgTdYtDQ/exec";

  let globalNickname = "";
  let globalRole = "";   // 志工、大隊長、管理員
  let globalTeam = "";   // 當前志工所屬大隊

  /* ------------------------------------------
      1. 初始化：登入 LIFF 並取得資料
  -------------------------------------------*/
  async function main() {

    await liff.init({ liffId: "2007934728-jZkMLlPO" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    globalNickname = profile.displayName;

    // step2 → 向 GAS 要 user 資料（權限/大隊等）
    loadUserInfo(globalNickname);
  }


  /* ------------------------------------------
      2. 讀取使用者權限 + 大隊等資訊
  -------------------------------------------*/
  async function loadUserInfo(nickname) {

  // 嘗試從 localStorage 讀取快取
  const cache = localStorage.getItem("userInfoCache");
  if (cache) {
    const parsed = JSON.parse(cache);
    const now = Date.now();
    if (now - parsed.timestamp < 180 * 24 * 60 * 60 * 1000) {
      globalRole = parsed.role;
      globalTeam = parsed.team;
      globalName = parsed.name;
      loadRecordList();
      return;
    }
  }

  // ★ 向「志工名單 WebApp」要資料
  const res = await fetch(`${VOLUNTEER_API_URL}?action=query&nickname=${nickname}`);
  const json = await res.json();

  if (!json.success) {
    document.getElementById("listContainer").innerHTML = "找不到您的志工資料";
    return;
  }

  globalName = json.data.姓名;
  globalTeam = json.data.大隊;
  globalRole = json.data.權限;

  // 寫入 localStorage
  localStorage.setItem("userInfoCache", JSON.stringify({
    name: globalName,
    team: globalTeam,
    role: globalRole,
    timestamp: Date.now()
  }));

  loadRecordList();
}

  /* ------------------------------------------
      3. 從 GAS 取得回報記錄（未來串 API）
  -------------------------------------------*/
  async function loadRecordList() {

  const url = `${REPORT_GAS_URL}?action=listReports&nickname=${globalNickname}`;
  const res = await fetch(url);
  const json = await res.json();

  if (!json.success) {
    document.getElementById("listContainer").innerHTML = "無法取得巡視紀錄";
    return;
  }

  const list = json.records || [];
  renderList(list);
}


  /* ------------------------------------------
      4. 渲染「年度 → 月份 → 日期 → 紀錄」
  -------------------------------------------*/
  function renderList(records) {

  const container = document.getElementById("listContainer");
  container.innerHTML = "";

  // 取得現在的年份與月份（民國）
  const now = new Date();
  const currentYear = now.getFullYear() - 1911;  // 轉換為民國年
  const currentMonth = now.getMonth() + 1;

  // --- step 1：先把 records 按 yyyy/mm/dd 分組 ---
  const grouped = {};  // grouped[month][day] = [records]

  for (let m = 1; m <= 12; m++) grouped[m] = {};

  records.forEach(r => {
    const dateParts = r.日期.split("/");
    const m = parseInt(dateParts[1], 10);
    const d = parseInt(dateParts[2], 10);

    if (!grouped[m][d]) grouped[m][d] = [];
    grouped[m][d].push(r);
  });

  // --- step 2：建立年份大區塊 ---
  const yearBlock = createBlock(`${currentYear} 年`, "year");
  const yearContent = yearBlock.querySelector(".content");

  // --- step 3：依照「最新月份」→「最舊月份」排序 ---
  const months = [];
  for (let i = 0; i < 12; i++) {
    let m = currentMonth - i;
    if (m <= 0) m += 12;
    months.push(m);
  }

  months.forEach(month => {

    const monthBlock = createBlock(`${month} 月`, "month");
    const monthContent = monthBlock.querySelector(".content");

    const days = Object.keys(grouped[month]).sort((a, b) => b - a); // 最新日期在前

    if (days.length === 0) {
      // 無紀錄的月份
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "record";
      emptyDiv.textContent = "本月無巡視紀錄";
      monthContent.appendChild(emptyDiv);
    } else {

      // --- 列出日期 ---
      days.forEach(day => {

        const dayBlock = createBlock(`${day} 日`, "day");
        const dayContent = dayBlock.querySelector(".content");

        grouped[month][day].forEach(record => {

          const div = document.createElement("div");
          div.className = "record";
          div.textContent = record.回報者 + "－巡視紀錄";

          div.onclick = function () {
            window.location.href = record.詳細紀錄; // 直接跳到 Display.html
          };

          dayContent.appendChild(div);
        });

        monthContent.appendChild(dayBlock);
      });
    }

    yearContent.appendChild(monthBlock);
  });

  container.appendChild(yearBlock);

  // 顯示最終畫面
  document.getElementById("loading").style.display = "none";
  container.style.display = "block";
}


  /* ------------------------------------------
      5. 工具：建立可收合區塊
  -------------------------------------------*/
  function createBlock(title, level) {
  const block = document.createElement("div");
  block.className = level + "-block";

  const header = document.createElement("div");
  header.className = "header";
  header.textContent = title;

  const content = document.createElement("div");
  content.className = "content";
  content.style.display = "none";

  header.onclick = () => {
    content.style.display = content.style.display === "none" ? "block" : "none";
  };

  block.appendChild(header);
  block.appendChild(content);

  return block;
}

  main();
</script>

</body>
</html>
