<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>防汛通報系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      padding: 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .year-block, .month-block, .day-block {
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      background: white;
      margin-bottom: 4px;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      background: #e8eef8;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-icon svg {
  width: 26px;
  height: 26px;
  color: #333;
}

/* 展開後 header 的下方要留距離 */
.header + .content {
  margin-top: 4px;
}

    .content {
      display: none;
      padding: 0 16px 12px;
    }

    .record {
  display: flex;
  align-items: center;
  font-size: 18px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
  gap: 6px;
  cursor: pointer;
}

    .record:last-child {
      border-bottom: none;
    }

    /* 讓所有區塊之間保持距離 */
.year-block, .month-block, .day-block {
  margin-bottom: 14px;
}

/* 讓展開的內容不會緊貼 header */
.content {
  margin-top: 6px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: #E53935;
}

/* === 修正展開後的區塊間距 === */
/* 展開後的外框保留較大空隙 */
.block-open {
  margin-bottom: 12px !important;
}

/* 讓展開後的 content 有內距，避免黏住 */
.year-block > .content,
.month-block > .content,
.day-block > .content {
  padding-top: 10px;
}

/* 日期展開後的紀錄字體加大 */
.day-block .record {
  font-size: 20px;   /* 你可改成 20 / 24 */
}

/* 本月無巡視紀錄 字體與一般紀錄一致 */
.month-block .record {
  font-size: 20px;
}

#loadingMask {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-size: 28px;
  color: white;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #eee;
  border-top: 4px solid #0b5ed7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 14px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.loadingText {
  display: none;
}

#listContainer {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

#switchArea {
  display: flex;
  justify-content: space-between;  /* 左右排列 */
  text-align: center;
  margin-top:10px;
  margin-bottom:18px;
}

#adminFilterArea select {
  font-size: 20px;
  padding: 6px;
}
#adminFilterArea label {
  font-size: 20px;
}
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>

<!--
    <div id="debug" style="white-space: pre-line; font-size:14px; color:#c00; margin-bottom:16px;"></div>
-->

<div id="loadingMask">
  <div class="spinner"></div>

  <div id="text-loading" class="loadingText">載入中…</div>
  <div id="text-update" class="loadingText">資料更新中，請耐心等候…</div>
  <div id="text-init" class="loadingText">資料初始化中，請耐心等候…</div>

  <!-- 錯誤訊息預留（可選） -->
  <div id="text-error" class="loadingText">無法連線到資料來源</div>
  <div id="text-error-format" class="loadingText">資料格式錯誤，請聯絡管理員</div>
  <div id="text-error-notfound" class="loadingText">找不到您的志工資料</div>
</div>

<h2 id="pageTitle" style="display:none;">回報紀錄</h2>

<div id="switchArea" style="
  display:none;
  text-align:center;
  margin-top:10px;
  margin-bottom:18px;
">
  <button id="btnTeam" style="
  padding:6px 16px;
  font-size:22px;
  border:2px solid #0b5ed7;
  background:#0b5ed7;
  color:white;
  border-radius:6px;
  margin-right:6px;
">大隊紀錄</button>

<button id="btnSelf" style="
  padding:6px 16px;
  font-size:22px;
  border:2px solid #0b5ed7;
  background:white;
  color:#0b5ed7;
  border-radius:6px;
">我的紀錄</button>
</div>

<div id="adminFilterArea" style="display:none; padding:12px;">
  <!-- 大隊 -->
  <div style="margin-bottom:12px;">
    <label>大隊：</label>
    <select id="adminTeamSelect" style="font-size:20px; padding:6px;">
      <option value="全部">全部</option>
      <option value="1">第1大隊</option>
      <option value="2">第2大隊</option>
      <option value="3">第3大隊</option>
      <option value="4">第4大隊</option>
      <option value="5">第5大隊</option>
      <option value="6">第6大隊</option>
      <option value="7">第7大隊</option>
      <option value="8">第8大隊</option>
      <option value="9">第9大隊</option>
      <option value="10">第10大隊</option>
    </select>
  </div>

  <!-- 範圍 -->
  <div style="margin-bottom:12px;">
    <label>範圍：</label>
    <select id="adminDayRange" style="font-size:20px; padding:6px;">
      <option value="3" selected>最近 3 天</option>
      <option value="7">最近 7 天</option>
      <option value="14">最近 14 天</option>
    </select>
  </div>

  <!-- 時間 -->
  <div style="margin-bottom:12px;">
    <label>時間：</label>
    <input type="time" id="timeStart" value="00:00" style="font-size:20px; width:120px; padding:6px;">
    ～ 
    <input type="time" id="timeEnd" value="23:59" style="font-size:20px; width:120px; padding:6px;">
  </div>

  <!-- 通報類型 -->
  <div style="margin-bottom:12px;">
    <label>類型：</label>
    <select id="adminTypeSelect" style="font-size:20px; padding:6px;">
      <option value="全部">全部</option>
      <option value="平時">平時</option>
      <option value="災中">災中</option>
      <option value="其他">其他</option>
    </select>
  </div>

  <button id="adminSearchBtn" style="
    margin-top:10px;
    padding:10px;
    font-size:20px;
    background:#0b5ed7;
    border:2px solid #0b5ed7;
    color:white;
    border-radius:6px;
    width:auto; /* 根據字體大小調整寬度 */
    display:block;
    margin-left:auto;
    margin-right:auto;
  ">搜尋</button>
</div>

<div id="centerSpinner" style="
  display:none;
  width:100%;
  padding:40px 0;
  justify-content:center;
  align-items:center;
  flex-direction:column;
">
  <div class="spinner"></div>
  <div style="font-size:22px; color:#666; margin-top:10px;">載入中...</div>
</div>

<!-- 清單真正呈現的地方，一開始先隱藏 -->
<div id="listContainer" style="display: none;"></div>

<script>

  const VOLUNTEER_API_URL = "https://script.google.com/macros/s/AKfycbxiGSG5hSMO6We-C6cyEJZLgf4Rnbjp-6w9Tmb0qfF9VM6JB4YGEMqj3QRfTzg7Czpc/exec"; 
const REPORT_GAS_URL = "https://script.google.com/macros/s/AKfycbxOWIHS04mtcTRdJNvnWnGOwBnlGPwG3tQOU0qgN5feabS7hbRrIM4bU1_T8VrXaA1-8g/exec";

let globalAdminRecords = [];   // 管理員一次抓全部後存在這邊
  let adminViewDays = 14;        // 預設抓最近兩週，可改 30
  let globalNickname = "";
  let globalRole = "";
  let globalTeam = "";
  let globalName = "";  // ★ 必須補這行
  let viewMode = "";  // self = 看自己, team = 看大隊

function debug(msg) {
  try {
    const box = document.getElementById("debug");
    if (box) box.textContent += msg + "\n";
  } catch (e) {}
}

  /* ------------------------------------------
      1. 初始化：登入 LIFF 並取得資料
  -------------------------------------------*/
  async function main() {
    // 隱藏按鈕直到資料加載完成
    document.getElementById("switchArea").style.display = "none"; 

    await liff.init({ liffId: "2007934728-jZkMLlPO" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    globalNickname = profile.displayName;

    // 進一步獲取用戶資訊
    loadUserInfo(globalNickname);
  }

  /* ------------------------------------------
      2. 讀取使用者權限 + 大隊等資訊
  -------------------------------------------*/
  async function loadUserInfo(nickname) {
  const oldCache = localStorage.getItem("userInfoCache");
  if (oldCache) {
    const parsedOld = JSON.parse(oldCache);
    if (!parsedOld.role) {
      localStorage.removeItem("userInfoCache");
    }
  }

  const mask = document.getElementById("loadingMask");
  const tLoad = document.getElementById("text-loading");
  const tUpdate = document.getElementById("text-update");
  const tInit = document.getElementById("text-init");

  tLoad.style.display = "none";
  tUpdate.style.display = "none";
  tInit.style.display = "none";
  mask.style.display = "flex";

  const cache = localStorage.getItem("userInfoCache");
  const now = Date.now();
  const expires = 10 * 1000; // 測試

  if (cache) {
    const parsed = JSON.parse(cache);

    if (now - parsed.timestamp < expires) {
      tLoad.style.display = "block";
      globalRole = parsed.role;
      globalTeam = parsed.team;
      globalName = parsed.name;

      // 根據角色設置 `viewMode`
      if (globalRole === "管理員") {
        viewMode = "admin";  // 管理員進入管理員模式，篩選區域顯示
        loadRecordList("admin");
        document.getElementById("adminFilterArea").style.display = "block";  // 顯示篩選區域
      } else if (globalRole === "大隊長") {
        viewMode = "team";  // 大隊長進入大隊紀錄模式
        loadRecordList("team");
      } else {
        viewMode = "self";  // 一般志工只查看自己的紀錄
        loadRecordList("self");
      }
      return;
    }
    tUpdate.style.display = "block";
  } else {
    tInit.style.display = "block";
  }

  // 呼叫 API 以獲取用戶資料
  const url = `${VOLUNTEER_API_URL}?action=query&nickname=${nickname}`;
  let res, text;
  try {
    res = await fetch(url);
    text = await res.text();
  } catch (err) {
    document.getElementById("text-error").style.display = "block";
    return;
  }

  if (text.startsWith("callback")) {
    text = text.replace(/^callback\(/, "").replace(/\);$/, "");
  }

  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    document.getElementById("text-error-format").style.display = "block";
    return;
  }

  if (!json.success) {
    document.getElementById("text-error-notfound").style.display = "block";
    return;
  }

  globalName = json.data.姓名;
  globalTeam = json.data.大隊;
  globalRole = json.data.權限 || "志工";

  localStorage.setItem("userInfoCache", JSON.stringify({
    name: globalName,
    team: globalTeam,
    role: globalRole,
    timestamp: Date.now()
  }));

  // 根據角色設定 `viewMode`
  if (globalRole === "管理員") {
    viewMode = "admin";  // 進入管理員模式
    loadRecordList("admin");
    document.getElementById("adminFilterArea").style.display = "block";  // 顯示篩選區域
  } else if (globalRole === "大隊長") {
    viewMode = "team";  // 進入大隊紀錄模式
    loadRecordList("team");
  } else {
    viewMode = "self";  // 進入自我紀錄模式
    loadRecordList("self");
  }
}

  /* ------------------------------------------
      3. 從 GAS 取得回報記錄（未來串 API）
  -------------------------------------------*/
  async function loadRecordList(mode = "self") {
  // 隱藏篩選欄位，在資料加載之前
  document.getElementById("adminFilterArea").style.display = "none";
  
  let url = "";
  if (mode === "self") {
    url = `${REPORT_GAS_URL}?action=listMyReports&nickname=${globalNickname}`;
  } else if (mode === "team") {
    url = `${REPORT_GAS_URL}?action=listTeamReports&nickname=${globalNickname}`;
  } else if (mode === "admin") {
    url = `${REPORT_GAS_URL}?action=listAdminFull&days=${adminViewDays}`;
  }

  let res, text;
  try {
    res = await fetch(url);
    text = await res.text();
  } catch (err) {
    document.getElementById("listContainer").innerHTML = "資料加載失敗（連線錯誤）";
    return;
  }

  // 資料加載後顯示篩選欄位
  document.getElementById("adminFilterArea").style.display = "block";

  // 處理 API 回應
  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    document.getElementById("listContainer").innerHTML = "資料格式錯誤，請聯絡管理員";
    return;
  }

  if (!json.success) {
    document.getElementById("listContainer").innerHTML = "無法取得資料";
    return;
  }

  // 渲染資料
  const list = json.records || [];
  globalRecords = list;
  renderList(list);  

  // 更新界面
  updateSwitchUI(); 
}

async function loadRecordList(mode = "admin") {  // 預設為管理員模式
  // 在資料加載時隱藏篩選區域
  document.getElementById("adminFilterArea").style.display = "none";

  let url = "";
  let dayRange = document.getElementById("adminDayRange").value || "3";  // 預設篩選範圍為最近 3 天

  // 根據 mode 來設置 API URL
  if (mode === "self") {
    url = `${REPORT_GAS_URL}?action=listMyReports&nickname=${globalNickname}&days=${dayRange}`;
  } else if (mode === "team") {
    url = `${REPORT_GAS_URL}?action=listTeamReports&nickname=${globalNickname}&days=${dayRange}`;
  } else if (mode === "admin") {
    url = `${REPORT_GAS_URL}?action=listAdminFull&days=${dayRange}`;  // 管理員模式
  }

  let res, text;
  try {
    res = await fetch(url);
    text = await res.text();
  } catch (err) {
    document.getElementById("listContainer").innerHTML = "資料加載失敗（連線錯誤）";
    return;
  }

  // 資料加載後顯示篩選區域
  document.getElementById("adminFilterArea").style.display = "block";

  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    document.getElementById("listContainer").innerHTML = "資料格式錯誤，請聯絡管理員";
    return;
  }

  if (!json.success) {
    document.getElementById("listContainer").innerHTML = "無法取得資料";
    return;
  }

  const list = json.records || [];
  globalRecords = list;
  renderList(list);  

  updateSwitchUI(); 
}

  /* ------------------------------------------
      4. 渲染「年度 → 月份 → 日期 → 紀錄」
  -------------------------------------------*/
  function normalizeDate(dateStr) {
  // 若是 ISO 格式：2025-11-11T16:00:00.000Z
  if (dateStr.includes("T")) {
    const d = new Date(dateStr);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd}`;
  }
  return dateStr; // 若本來就是 yyyy/mm/dd
}

function filterAdminRecords() {
  let records = [...globalAdminRecords]; // 複製原始資料

  // 1. 篩選大隊
  let targetTeam = document.getElementById("adminTeamSelect")?.value || "全部";
  if (targetTeam !== "全部") {
    records = records.filter(r => (r.所屬大隊 + "") === targetTeam);
  }

  // 2. 範圍（最近 adminViewDays 天） → 這個會在外面同步更新
  const now = new Date();
  const cutoff = new Date(now.getTime() - adminViewDays * 24 * 60 * 60 * 1000);

  records = records.filter(r => {
    let ds = normalizeDate(r.日期);
    return new Date(ds) >= cutoff;
  });

  // 3. 篩選通報類型
  let targetType = document.getElementById("adminTypeSelect")?.value || "全部";
  if (targetType !== "全部") {
    records = records.filter(r => {
      const type = (r.通報類型 || "").trim();
      return type === targetType;
    });
  }

  // 4. 自訂時間區段（取 timeStart / timeEnd）
  const start = document.getElementById("timeStart")?.value || "00:00";
  const end   = document.getElementById("timeEnd")?.value || "23:59";

  const [sh, sm] = start.split(":").map(Number);
  const [eh, em] = end.split(":").map(Number);

  records = records.filter(r => {
    const link = r.詳細紀錄 || "";
    const match = link.match(/report_(\d+)/);
    if (!match) return false;

    const t = parseInt(match[1], 10);
    const d = new Date(t);
    const h = d.getHours();
    const m = d.getMinutes();

    const total = h * 60 + m;
    const sTotal = sh * 60 + sm;
    const eTotal = eh * 60 + em;

    return total >= sTotal && total <= eTotal;
  });

  return records;
}

function renderList(records) {
  const container = document.getElementById("listContainer");
  const spinner = document.getElementById("centerSpinner");
  const mask = document.getElementById("loadingMask");

  if (mask.style.display !== "none") {
    container.style.display = "none";
    spinner.style.display = "none";
    document.getElementById("pageTitle").style.display = "block";
  } else {
    spinner.style.display = "flex";
    container.style.display = "none";
  }

  let finalRecords = records;
  if (viewMode === "self") {
    finalRecords = records.filter(r => (r.回報者 || "").trim() === globalName);  // 只顯示自己的紀錄
  }

  globalRecords = records;
  container.innerHTML = "";  // 清空容器中的內容

  const now = new Date();
  const currentYear = now.getFullYear() - 1911;
  const currentMonth = now.getMonth() + 1;

  const grouped = {};  // 用來儲存分組的資料，根據年月日分組
  for (let m = 1; m <= 12; m++) grouped[m] = {};  // 初始化每個月份的區塊

  finalRecords.forEach(r => {
    const normalized = normalizeDate(r.日期);  // 格式化日期
    const dateParts = normalized.split("/");  // 取得年/月/日
    const m = parseInt(dateParts[1], 10);  // 取得月份
    const d = parseInt(dateParts[2], 10);  // 取得日期

    if (!grouped[m][d]) grouped[m][d] = [];
    grouped[m][d].push(r);  // 分組後儲存紀錄
  });

  const yearBlock = createBlock(`${currentYear} 年`, "year");
  const yearContent = yearBlock.querySelector(".content");

  const months = Object.keys(grouped)
    .map(m => parseInt(m, 10))
    .filter(m => Object.keys(grouped[m]).length > 0)
    .filter(m => m <= currentMonth)
    .sort((a, b) => b - a);

  months.forEach(month => {
    const monthBlock = createBlock(`${month} 月`, "month");
    const monthContent = monthBlock.querySelector(".content");

    const days = Object.keys(grouped[month]).sort((a, b) => b - a);

    if (days.length === 0) {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "record";
      emptyDiv.textContent = "本月無巡視紀錄";
      monthContent.appendChild(emptyDiv);
    } else {
      days.forEach(day => {
        const dayBlock = createBlock(`${day} 日`, "day");
        const dayContent = dayBlock.querySelector(".content");

        grouped[month][day].forEach(record => {
          const div = document.createElement("div");
          div.className = "record";

          // 時間解析
          let hh = "--", mm = "--";
          let ampm = "";

          try {
            const match = record.詳細紀錄.match(/report_(\d+)/);
            if (match) {
              const t = parseInt(match[1], 10);
              const dateObj = new Date(t);

              const hours = dateObj.getHours();
              hh = String(hours).padStart(2, "0");
              mm = String(dateObj.getMinutes()).padStart(2, "0");
              ampm = "";
            }
          } catch (e) {
            console.warn("無法解析時間：", record.詳細紀錄);
          }

          const status = (record.狀態 || "").trim();
          const isAbnormal = status === "異常";

          const timeText = document.createElement("span");
          timeText.textContent = `${hh}:${mm}｜${status}`;
          div.appendChild(timeText);

          if (viewMode === "team") {
            const nameSpan = document.createElement("span");
            nameSpan.textContent = `｜${record.回報者}`;
            div.appendChild(nameSpan);
          }

          if (isAbnormal) {
            const dot = document.createElement("span");
            dot.className = "status-dot";
            div.appendChild(dot);
          }

          div.onclick = () => {
            window.location.href = record.詳細紀錄;
          };

          dayContent.appendChild(div);
        });

        monthContent.appendChild(dayBlock);
      });
    }

    yearContent.appendChild(monthBlock);
  });

  container.appendChild(yearBlock);

  document.getElementById("loadingMask").style.display = "none";
  container.style.display = "block";
  spinner.style.display = "none";
}

  /* ------------------------------------------
      5. 工具：建立可收合區塊
  -------------------------------------------*/
  function createBlock(title, level) {
  const block = document.createElement("div");
  block.className = level + "-block";

  const header = document.createElement("div");
  header.className = "header";

  const titleSpan = document.createElement("span");
  titleSpan.textContent = title;

  // ▼（預設收起用）
  const icon = document.createElement("span");
  icon.className = "toggle-icon";
  icon.innerHTML = `
  <svg width="40" height="40" viewBox="0 0 24 24">
    <path fill="#666" d="M5 8l7 8 7-8z"/>
  </svg>
`;

  const content = document.createElement("div");
  content.className = "content";
  content.style.display = "none";

  header.appendChild(titleSpan);
  header.appendChild(icon);

  header.onclick = () => {
  const willOpen = content.style.display !== "block";

  content.style.display = willOpen ? "block" : "none";

  icon.innerHTML = willOpen
    ? `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 16l7-8 7 8z"/>  <!-- 向上 -->
       </svg>`
    : `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 8l7 8 7-8z"/>  <!-- 向下 -->
       </svg>`;
};

  block.appendChild(header);
  block.appendChild(content);

  return block;
}

// 按鈕點擊事件
document.getElementById("btnSelf").onclick = function () {
  viewMode = "self";  // 切換到自己的紀錄
  document.getElementById("adminFilterArea").style.display = "none";  // 隱藏管理員篩選區域
  renderLoadingInList();
  loadRecordList("self");
};

document.getElementById("btnTeam").onclick = async function () {
  if (globalRole === "管理員") {
    viewMode = "admin";  // 管理員查看所有紀錄
    document.getElementById("adminFilterArea").style.display = "block";  // 顯示篩選區域
    renderLoadingInList();
    loadRecordList("admin");
  } else if (globalRole === "大隊長") {
    viewMode = "team";  // 大隊長查看自己大隊的紀錄
    renderLoadingInList();
    loadRecordList("team");
  }
};

// 管理員搜尋
document.getElementById("adminSearchBtn").onclick = () => {
  if (viewMode !== "admin") return;  // 確保在 admin 模式下才動作

  // 更新篩選條件
  adminViewDays = Number(document.getElementById("adminDayRange").value);

  // 篩選資料
  const filtered = filterAdminRecords();

  // 渲染篩選後的資料
  renderList(filtered);
};

// 按鈕視覺切換
function updateSwitchUI() {
  const btnSelf = document.getElementById("btnSelf");
  const btnTeam = document.getElementById("btnTeam");

  if (viewMode === "self") {
    btnSelf.style.background = "#0b5ed7";
    btnSelf.style.color = "white";
    btnTeam.style.background = "white";
    btnTeam.style.color = "#0b5ed7";
  } else if (viewMode === "team") {
    btnTeam.style.background = "#0b5ed7";
    btnTeam.style.color = "white";
    btnSelf.style.background = "white";
    btnSelf.style.color = "#0b5ed7";
  } else if (viewMode === "admin") {
    btnTeam.style.background = "#0b5ed7";
    btnTeam.style.color = "white";
    btnSelf.style.background = "white";
    btnSelf.style.color = "#0b5ed7";
  }
}

function showLoadingMask() {
  document.getElementById("loadingMask").style.display = "flex";
}

function renderLoadingInList() {
  const container = document.getElementById("listContainer");
  const spinner = document.getElementById("centerSpinner");

  container.style.display = "none";
  spinner.style.display = "flex";

  // 不要顯示大遮罩
  document.getElementById("loadingMask").style.display = "none";
}

// 篩選區域顯示隱藏邏輯
function showAdminFilterArea() {
  document.getElementById("adminFilterArea").style.display = "block";
}

function hideAdminFilterArea() {
  document.getElementById("adminFilterArea").style.display = "none";
}

  main();
</script>

</body>
</html>