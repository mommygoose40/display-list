<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>巡視紀錄列表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      padding: 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .year-block, .month-block, .day-block {
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      background: white;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      background: #e8eef8;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .content {
      display: none;
      padding: 0 16px 12px;
    }

    .record {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: 18px;
    }

    .record:last-child {
      border-bottom: none;
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>

<div id="debug" style="white-space: pre-line; font-size:14px; color:#c00; margin-bottom:16px;"></div>

<h2>巡視紀錄列表</h2>

<!-- 初始化時顯示（抓權限、抓紀錄、準備資料） -->
<div id="loading" style="
  font-size: 18px;
  text-align: center;
  padding: 20px;
  color: #555;
">
  資料初始化中，請稍候…
</div>

<!-- 清單真正呈現的地方，一開始先隱藏 -->
<div id="listContainer" style="display: none;"></div>

<script>

  const VOLUNTEER_API_URL = "https://script.google.com/macros/s/AKfycbxiGSG5hSMO6We-C6cyEJZLgf4Rnbjp-6w9Tmb0qfF9VM6JB4YGEMqj3QRfTzg7Czpc/exec"; 
const REPORT_GAS_URL = "https://script.google.com/macros/s/AKfycbyoNSMy8VInpBuEYsF4J_QQ2uwsV43b1caD6TYIcK_ABrw7y4rewdJq3bSOYSwgTdYtDQ/exec";

let globalNickname = "";
let globalRole = "";
let globalTeam = "";
let globalName = "";  // ★ 必須補這行

function debug(msg) {
  const box = document.getElementById("debug");
  box.textContent += msg + "\n";
}

  /* ------------------------------------------
      1. 初始化：登入 LIFF 並取得資料
  -------------------------------------------*/
  async function main() {

    await liff.init({ liffId: "2007934728-jZkMLlPO" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    globalNickname = profile.displayName;

    // step2 → 向 GAS 要 user 資料（權限/大隊等）
    loadUserInfo(globalNickname);
  }


  /* ------------------------------------------
      2. 讀取使用者權限 + 大隊等資訊
  -------------------------------------------*/
  async function loadUserInfo(nickname) {

  // === ★ 第 0 步：開始讀取使用者資料 ===
  debug("STEP1: 開始取得志工資料，nickname=" + nickname);

  // localStorage 快取
  const cache = localStorage.getItem("userInfoCache");
  if (cache) {
    const parsed = JSON.parse(cache);
    const now = Date.now();
    if (now - parsed.timestamp < 180 * 24 * 60 * 60 * 1000) {
      debug("STEP1-使用 localStorage 快取：" + JSON.stringify(parsed));
      globalRole = parsed.role;
      globalTeam = parsed.team;
      globalName = parsed.name;
      loadRecordList();
      return;
    }
  }

  // === ★ STEP1-API call: 向志工名單 WebApp 要資料 ===
  const url = `${VOLUNTEER_API_URL}?action=query&nickname=${nickname}`;
  debug("STEP1-API 呼叫：" + url);

  const res = await fetch(url);
  let text = await res.text();

  debug("STEP1-API 回傳原始資料：" + text);

  // JSONP → 去 callback()
  if (text.startsWith("callback")) {
    text = text.replace(/^callback\(/, "").replace(/\);$/, "");
    debug("STEP1-去除JSONP後：" + text);
  }

  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    document.getElementById("loading").innerHTML = "志工資料來源格式錯誤，請聯絡管理員。";
    debug("STEP1-JSON 解析錯誤：" + err + "\n原始：" + text);
    return;
  }

  debug("STEP1-解析後 JSON：" + JSON.stringify(json));

  if (!json.success) {
    document.getElementById("loading").innerHTML = "找不到您的志工資料";
    debug("STEP1-找不到志工資料");
    return;
  }

  // === ★ 正常成功 ===
  globalName = json.data.姓名;
  globalTeam = json.data.大隊;
  globalRole = json.data.權限 || "志工";

  debug("STEP1-成功取得志工資料：" + JSON.stringify({
    name: globalName,
    team: globalTeam,
    role: globalRole
  }));

  localStorage.setItem("userInfoCache", JSON.stringify({
    name: globalName,
    team: globalTeam,
    role: globalRole,
    timestamp: Date.now()
  }));

  loadRecordList();
}

  /* ------------------------------------------
      3. 從 GAS 取得回報記錄（未來串 API）
  -------------------------------------------*/
  async function loadRecordList() {

  const url = `${REPORT_GAS_URL}?action=listReports&nickname=${globalNickname}`;
  debug("STEP2: 開始取得巡視紀錄：" + url);

  let res, text;

  try {
    res = await fetch(url);
    text = await res.text();
  } catch (err) {
    debug("STEP2-連線失敗：" + err);
    document.getElementById("loading").innerHTML = "巡視紀錄載入失敗（連線錯誤）";
    return;
  }

  debug("STEP2-API 回傳原始資料：" + text);

  // JSONP → 去掉 callback(...);
  if (text.startsWith("callback")) {
    text = text.replace(/^callback\(/, "").replace(/\);$/, "");
    debug("STEP2-去除 JSONP 後：" + text);
  }

  let json;
  try {
    json = JSON.parse(text);
  } catch (err) {
    debug("STEP2-JSON 解析失敗：" + err + "\n原始：" + text);
    document.getElementById("loading").innerHTML = "巡視紀錄格式錯誤，請聯絡管理員";
    return;
  }

  debug("STEP2-解析後 JSON：" + JSON.stringify(json));

  if (!json.success) {
    document.getElementById("listContainer").innerHTML = "無法取得巡視紀錄";
    debug("STEP2-巡視紀錄載入失敗：" + JSON.stringify(json));
    return;
  }

  const list = json.records || [];
  debug("STEP2-成功取得紀錄數量：" + list.length);

  renderList(list);
}


  /* ------------------------------------------
      4. 渲染「年度 → 月份 → 日期 → 紀錄」
  -------------------------------------------*/
  function normalizeDate(dateStr) {
  // 若是 ISO 格式：2025-11-11T16:00:00.000Z
  if (dateStr.includes("T")) {
    const d = new Date(dateStr);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd}`;
  }
  return dateStr; // 若本來就是 yyyy/mm/dd
}

function renderList(records) {

  debug("STEP3: 進入 renderList，records 長度=" + records.length);

  const container = document.getElementById("listContainer");
  container.innerHTML = "";

  // 取得現在的年份與月份（民國）
  const now = new Date();
  const currentYear = now.getFullYear() - 1911;
  const currentMonth = now.getMonth() + 1;

  // --- step 1：把 records 按 月 / 日 分組 ---
  const grouped = {};  // grouped[month][day] = [records]
  for (let m = 1; m <= 12; m++) grouped[m] = {};

  records.forEach(r => {

    // ★ 修正日期格式
    const normalized = normalizeDate(r.日期);
    debug("STEP3-日期修正：" + r.日期 + " → " + normalized);

    const dateParts = normalized.split("/");
    const m = parseInt(dateParts[1], 10);
    const d = parseInt(dateParts[2], 10);

    if (!grouped[m][d]) grouped[m][d] = [];
    grouped[m][d].push(r);
  });

  debug("STEP3-1: 日期分組完成");

  // --- step 2：建立年份區塊 ---
  const yearBlock = createBlock(`${currentYear} 年`, "year");
  const yearContent = yearBlock.querySelector(".content");

  // --- step 3：最新月份 → 最舊月份 ---
  const months = [];
  for (let i = 0; i < 12; i++) {
    let m = currentMonth - i;
    if (m <= 0) m += 12;
    months.push(m);
  }
  debug("STEP3-2 顯示月份排列 = " + months.join(", "));

  // --- step 4：逐月渲染 ---
  months.forEach(month => {

    const monthBlock = createBlock(`${month} 月`, "month");
    const monthContent = monthBlock.querySelector(".content");

    const days = Object.keys(grouped[month]).sort((a, b) => b - a);

    if (days.length === 0) {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "record";
      emptyDiv.textContent = "本月無巡視紀錄";
      monthContent.appendChild(emptyDiv);
    } else {

      // --- 列出日期 ---
      days.forEach(day => {

        const dayBlock = createBlock(`${day} 日`, "day");
        const dayContent = dayBlock.querySelector(".content");

        grouped[month][day].forEach(record => {

          const div = document.createElement("div");
          div.className = "record";
          div.textContent = record.回報者 + "－巡視紀錄";

          div.onclick = () => {
            window.location.href = record.詳細紀錄;
          };

          dayContent.appendChild(div);
        });

        monthContent.appendChild(dayBlock);
      });
    }

    yearContent.appendChild(monthBlock);
  });

  container.appendChild(yearBlock);

  // 顯示最終畫面
  document.getElementById("loading").style.display = "none";
  container.style.display = "block";

  debug("STEP3 完成：列表渲染成功");
}

  /* ------------------------------------------
      5. 工具：建立可收合區塊
  -------------------------------------------*/
  function createBlock(title, level) {
  const block = document.createElement("div");
  block.className = level + "-block";

  const header = document.createElement("div");
  header.className = "header";
  header.textContent = title;

  const content = document.createElement("div");
  content.className = "content";
  content.style.display = "none";

  header.onclick = () => {
    content.style.display = content.style.display === "none" ? "block" : "none";
  };

  block.appendChild(header);
  block.appendChild(content);

  return block;
}

  main();
</script>

</body>
</html>
